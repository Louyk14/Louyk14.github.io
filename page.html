<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
		<title>My first Three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body id="wf">
		<script src="js/three.js"></script>
		<script src="VTKLoader.js"></script>
		<script src="OBJLoader.js"></script>
		<script src="JSONLoader.js"></script>
		<script src="ImageLoader.js"></script>
		<script>
		var scene = new THREE.Scene();
		var cubeCamera = new THREE.CubeCamera( 1, 100000, 128 );
		var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000); 

		scene.add(cubeCamera);

		var movedirection = 0;  

		// 创建光源 
			var pointLight = new THREE.PointLight(0xFFFFFF);  
			pointLight.position.x = 0; 
			pointLight.position.y = 50; 
			pointLight.position.z = 0; 
			scene.add(pointLight); 

		//重力相关
			var jump_up_time = 99;
			var g = 0.000049;
			var jumping_time = [];
			var isJumping = [];
			var jump_dis = [];
			jumping_time.push(0);
			isJumping.push(false);
			var jumpTimer = null;


			for(var i = 0; i <= jump_up_time + 1; i++)
			{
				jump_dis.push(0);		
			}

			for(var i = jump_up_time; i >= 0; i--)
			{
				jump_dis[i] = 0.5 * g * (jump_up_time + 1 - i) * (jump_up_time + 1 - i) - jump_dis[i + 1];
			}

			function jumpMove()
			{
				if(isJumping[0] == true)
				{
					if(jumping_time[0] <= jump_up_time)
					{
						person_model.translateY(jump_dis[jumping_time[0]]);
						camera.translateY(jump_dis[jumping_time[0]]);
					}
					else
					{
						person_model.translateY(-1 * jump_dis[2 * jump_up_time + 1 - jumping_time[0]]);
						camera.translateY(-1 * jump_dis[2 * jump_up_time + 1 - jumping_time[0]]);
					}
					jumping_time[0]++;
					
					if(jumping_time[0] >= 2 * jump_up_time + 2)
					{
						isJumping[0] = false;
						jumping_time[0] = 0;
						clearInterval(jumpTimer);
					}
				}
			}

		//一些常量
			var mapsize = 20;
			var cube_side_length = 1;
			var cubes = [];
			var camera_step = 0.05;

		//图片、材料设置
			var grassmap = "grass.jpg";
			var grassTexture = THREE.ImageUtils.loadTexture(grassmap);
			var grassMatertial = new THREE.MeshBasicMaterial({map:grassTexture});

		//天空盒设置
			var skypic = "sky.jpg";
			var skypics = [skypic, skypic, skypic, skypic, skypic, skypic];
			var skyTextTure = THREE.ImageUtils.loadTextureCube(skypics);
			//skyTextTure.minFilter = THREE.LinearFilter;
			var shader = THREE.ShaderLib["cube"];
			shader.uniforms["tCube"].value = skyTextTure;
			var skyboxMaterial = new THREE.ShaderMaterial({
				uniforms: shader.uniforms,
				fragmentShader: shader.fragmentShader,
				vertexShader: shader.vertexShader,
				depthWrite: false,
				side: THREE.BackSide
			});
			var skyboxGeom = new THREE.BoxGeometry(500, 500, 500);
			skybox = new THREE.Mesh(skyboxGeom, skyboxMaterial);
			scene.add(skybox);

		//添加模型
			var model_texture = new THREE.ImageUtils.loadTexture("sdsd004.jpg");	
			var model_material = new THREE.MeshLambertMaterial({map: model_texture});
			
	        var loader = new THREE.JSONLoader();
	        
	        var person_model = null;
	        var enemy_model = null;
        	
        	loader.load("kulou.js",  function (event) {
	            var model_geometry = event;
	            var model_mesh = new THREE.Mesh(model_geometry, model_material);
	            person_model = model_mesh;
	            enemy_model = person_model.clone();

		        person_model.position.setY(0.8);
		        enemy_model.position.setY(0.8);
		        enemy_model.position.setX(5);

		        camera.position.setY(1.1);
		        camera.position.setX(0);
		        camera.position.setZ(-0.5);
		        camera.lookAt(new THREE.Vector3(0, 1.1, 1));

		        scene.add(person_model);
		        scene.add(enemy_model);
	        });

	    //子弹
	    	var bulletnum = 10;
	    	var bullets = [];
	    	var direct = [];
	      
	    //鼠标事件
	    	document.getElementById('wf').onmousedown=function(e){
	    		if(e.button == 0)
	    		{
	    			//开火
	    			var bullet = new THREE.Mesh(new THREE.SphereGeometry(0.1, 0.1), new THREE.MeshLambertMaterial({color:oxff0000}));
	    			bullet.position.set(person_model.position);
	    			scene.add(bullet);
	    			bullets.add(bullet);

	    			var projector = new THREE.Projector();
	    			
	    			var mouse3D = new THREE.Vector3(0, 0, 0);
	    			mouse3D.x = (e.clientX / window.innerWidth) * 2 - 1;
	    			mouse3D.y = -(e.clentY / window.innerHeight) * 2 + 1;
	    			mouse3D.z = 0.5;

	    			projector.unprojectVector(mouse3D, camera);
	    			var mouse_ray = new THREE.Ray(camera.position, mouse3D.subSelf(camera.position).normalize());

	    			console.log(mouse_ray.direction);
	    			direct.push(mouse_ray.direction);
	    		}
	    		else if(e.button == 2)
	    		{
	    			//挖
	    		}
	    	};

	    //
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild(renderer.domElement);
			
			document.onkeydown=function(event){
	            var e = event || window.event || arguments.callee.caller.arguments[0];
	            
	            if(e && e.keyCode==38)
	            { // 上
	                movedirection = 1;
	            }
	            if(e && e.keyCode==40)
	            { //下
	                movedirection = 2;
	            }            
	            if(e && e.keyCode==37)
	            { // 左
	            	movedirection = 3;
	            }
	            if(e && e.keyCode==39)
	            { // 右
	                movedirection = 4;
	            }
	            if(e && e.keyCode==32)
	            { // 空格
	                if(isJumping[0] == false)
	                {
	                	jumping_time[0] = 0;
	                	isJumping[0] = true;
	                	jumpTimer = setInterval('jumpMove()', 10);
	                }
	            }
	         };

	         document.onkeyup=function(event){
	            var e = event || window.event || arguments.callee.caller.arguments[0];

	            if(e && (e.keyCode==38 || e.keyCode==40 || e.keyCode==37 || e.keyCode==39))
	            { // 上
	                movedirection = 0;
	            }
	        }

         	function init()
         	{
				var geometry = new THREE.BoxGeometry(cube_side_length, cube_side_length, cube_side_length);
         		var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
         		var material_frame = new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: true, wireframeLinewidth: 2, vertexColors: 0x000000});

         		for(var i = 0; i < mapsize; i++)
				{
					for(var j = 0; j < mapsize; j++)
					{					
						/*var cube = new THREE.Mesh( geometry, material );
						scene.add(cube);
						cube.position.x = (j - (mapsize / 2)) * cube_side_length;
						cube.position.y = 0;
						cube.position.z = (i - (mapsize / 2)) * cube_side_length;*/

						var frame_cube = new THREE.Mesh( geometry, grassMatertial);
						scene.add(frame_cube);
						frame_cube.position.x = (j - (mapsize / 2)) * cube_side_length;
						frame_cube.position.y = 0;
						frame_cube.position.z = (i - (mapsize / 2)) * cube_side_length;
					}
				}
         	}

         	init();	

         	var mousepos = 0;
         	var mouseuppos = 0;
  
            document.getElementById('wf').onmousemove = function mouseMoveActor(event)
            {
                var e = event || window.event;
                if((e.screenX - (screen.width / 2)) > 150)
                {
                    mousepos = -1;
                    //person_model.rotation.y -= 0.01;
                }    
                else if((e.screenX - (screen.width / 2)) < -150)
                {
                    mousepos = 1;
                    //person_model.rotation.y += 0.01;
                }     
                else
                {
                    mousepos = 0;
                }       

                mouseuppos = -1 * ((e.clientY - document.body.clientHeight / 2) / (document.body.clientHeight / 2)) * Math.PI / 3;
            }


			var render = function () {
				//cubeperson_model.position.copy(cube.position);
				//cubeperson_model.updateCubeMap(renderer, scene);
				
				if(person_model != null)
				{
					var direction = person_model.getWorldDirection();
	            	direction.multiplyScalar(camera_step);
					
					if(movedirection == 1)
					{
						person_model.position.x += direction.x;
		                person_model.position.z += direction.z;
		                camera.position.x += direction.x;
		                camera.position.z += direction.z;
					}
					else if(movedirection == 2)
					{
						person_model.position.x -= direction.x;
		                person_model.position.z -= direction.z;
		                camera.position.x -= direction.x;
		                camera.position.z -= direction.z;
					}
					else if(movedirection == 3)
					{
						direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), Math.PI / 2);
		                person_model.position.x += direction.x;
		                person_model.position.z += direction.z;
		                camera.position.x += direction.x;
		                camera.position.z += direction.z;
					}
					else if(movedirection == 4)
					{
						direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), -Math.PI / 2);
		                person_model.position.x += direction.x;
		                person_model.position.z += direction.z;
		                camera.position.x += direction.x;
		                camera.position.z += direction.z;
					}
					
					person_model.rotation.y += (0.01 * mousepos);
					camera.rotation.y -= (0.01 * mousepos);
					camera.rotation.x = Math.PI + mouseuppos;
					if(Math.abs(Math.abs(person_model.rotation.y) - 6.28) <= 0.005)
					{
						person_model.rotation.y = 0;
						camera.rotation.y = 0;
					}
				}

				for(var i = 0; i < bullets.length; i++)
				{
					if(bullet[i].position.x >= 30 || bullet[i].position.y >= 30
						|| bullet[i].position.z >= 30)
					{
						bullet.shift();
						bullets.shift();
					}
				}
				for(var i = 0; i < bullets.length; i++)
				{
					bullet[i].translateX(bullets[i].x);
					bullet[i].translateY(bullets[i].y);
					bullet[i].translateZ(bullets[i].z);
				}

				requestAnimationFrame(render);
				renderer.render(scene, camera);
			};

			render();

		//2D地图
			var two_dim_map_list = [];

			function two_dim_map_create()
			{
				for(var i = 0; i < 20; i++)
				{
					for(var j = 0; j < 20; j++)
					{
						var newDiv = document.createElement("div");
						var newSpan = document.createElement("span");
						newSpan.innerHTML = "0";
						newSpan.style.cssText = "font-size:8px;text-align:center;";
						newDiv.appendChild(newSpan);
						newDiv.style.cssText = "width: 10px;height: 10px;border: 1px solid black;position: absolute;left:" + i * 10 + "px;top: " + j * 10 + "px;margin: 0px;padding: 0px;text-align:center;";
						document.body.appendChild(newDiv);
						two_dim_map_list.push(newSpan);
					}
				}
			}
			
			two_dim_map_create();

		//碰撞检测
			function isCrashed()
			{
				var myobject = person_model;//arguments[0];
				var otherobject = [enemy_model];//arguments[1];

				console.log(myobject);

				var myPoint = myobject.position.clone();
				for(var i = 0; i < myobject.geometry.vertices.length; i++)
				{
					var localVertex = myobject.geometry.vertices[i].clone();
					var globalVertex = localVertex.applyMatrix4(myobject.matrix);
					var directionVector = globalVertex.sub(myobject.position);

					var ray = new THREE.Raycaster(myPoint, directionVector.clone().normalize());
					var collisionResults = ray.intersectObjects(otherobject);

					if(collisionResults.length > 0 && collisionResults[0].distance < directionVector.length())
					{
						return true;
					}
				}

				return false;
			}
		</script>
		
	</body>
</html>